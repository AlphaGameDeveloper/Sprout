name: PlatformIO Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write  # needed for creating releases and uploading assets

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build all PlatformIO environments
        id: build_envs
        run: |
          set -e
          PLATFORMS=("esp32") # Add more environments here in the future
          ASSETS=""
          NOTES=""
          mkdir -p release_assets
          for env in "${PLATFORMS[@]}"; do
            echo "Building environment: $env"
            if pio run -e $env; then
              NOTES="$NOTES$env **IS** supported\n"
              BIN_FILE=".pio/build/$env/firmware.bin"
              NEW_NAME="release_assets/firmware-${env}-${{ env.BUILD_NUMBER }}.bin"
              cp "$BIN_FILE" "$NEW_NAME"
              ASSETS="$ASSETS $NEW_NAME"
            else
              NOTES="$NOTES$env **IS NOT** supported\n"
            fi
          done
          # Write release notes to a file for body_file
          echo -e "$NOTES" > release_assets/release_notes.txt
          echo "RELEASE_ASSETS=$ASSETS" >> $GITHUB_ENV
          echo "RELEASE_NOTES_FILE=release_assets/release_notes.txt" >> $GITHUB_ENV

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Sprout v${{ github.run_number }}
          body_file: ${{ env.RELEASE_NOTES_FILE }}
          draft: false
          prerelease: false
          files: ${{ env.RELEASE_ASSETS }}
