name: PlatformIO Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write  # needed for creating releases and uploading assets

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build all PlatformIO environments
        id: build_envs
        run: |
          set -ex
          PLATFORMS=("esp32") # Add more environments here in the future
          ASSETS=""
          mkdir -p release_assets
          RELEASE_NOTES_FILE="release_assets/release_notes.txt"
          echo "# Sprout Firmware Release v${{ env.BUILD_NUMBER }}" > "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          # list previous commits since last tag
          git fetch --tags
          LAST_TAG=$(git describe --tags --abbrev=0 --always)
          echo "## Changelog" >> "$RELEASE_NOTES_FILE"
          echo "Changes since last tag ($LAST_TAG):" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          git log "$LAST_TAG..HEAD" --pretty=format:'* %h %s' >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "## Compatibility" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"

          for env in "${PLATFORMS[@]}"; do
            echo "Building environment: $env"
            if pio run -e $env; then
              echo "* $env **IS** supported" >> "$RELEASE_NOTES_FILE"
              BIN_FILE=".pio/build/$env/firmware.bin"
              NEW_NAME="release_assets/sprout-firmware-${env}-v${{ env.BUILD_NUMBER }}.bin"
              cp "$BIN_FILE" "$NEW_NAME"
              ASSETS="$ASSETS $NEW_NAME"
            else
              echo "* $env **IS NOT** supported" >> "$RELEASE_NOTES_FILE"
            fi
          done

          echo "---" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "Note: Make sure to flash the correct firmware binary for your device." >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          
          echo "RELEASE_ASSETS=$ASSETS" >> $GITHUB_ENV
          echo "RELEASE_NOTES_FILE=$RELEASE_NOTES_FILE" >> $GITHUB_ENV


      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Sprout v${{ github.run_number }}
          body_path: ${{ env.RELEASE_NOTES_FILE }}
          draft: false
          prerelease: false

      - name: Upload Binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload --clobber v${{ github.run_number }} ${{ env.RELEASE_ASSETS }}
